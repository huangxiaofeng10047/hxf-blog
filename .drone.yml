kind: pipeline
type: docker
name: default

steps:
# - name: themeclone
#   image: alpine/git
#   commands:
#   - git clone -b master http://192.168.50.16:1280/gitea/hexo-theme-sagiri.git themes/sagiri
- name: Hexo Build
  image: nikolaik/python-nodejs:latest
  volumes:
  - name: npm-cache   # npm 缓存挂载路径
    path: /root/.npm-cache
  commands:
    - npm config set registry https://registry.npm.taobao.org
    - cd themes/sagiri
    - npm install
    - cd ../../
    - npm install
    - npm install hexo-cli -g
    - npm install hexo-server --save
    - npm install hexo-asset-image --save
    - npm install hexo-wordcount --save
    - npm install hexo-generator-sitemap --save
    - npm install hexo-generator-baidu-sitemap --save
    - npm install hexo-deployer-git --save
    - npm run build 

- name: SCP File Transfer
  image: appleboy/drone-scp
  settings:
    target: /data/mywebroot/
    source: ./public
    host: 
      from_secret: ssh_host
    port: 
      from_secret: ssh_port
    username: 
      from_secret: ssh_username
    password:
      from_secret: ssh_password
    command_timeout: 
      from_secret: ssh_timeout
    # rm: true
  when:
    branch:
    - master
    event:
      exclude:
      - pull_request
- name: Web Deploy
  image: appleboy/drone-ssh
  settings:
    host: 
      from_secret: ssh_host
    port: 
      from_secret: ssh_port
    username: 
      from_secret: ssh_username
    password:
      from_secret: ssh_password
    script:
      - mv /data/mywebroot/public/* /data/mywebroot/
      - rm -rf /data/mywebroot/public/
volumes:
- name: npm-cache   # npm 缓存
  host:
    path: /tmp/cache/.npm-cache
trigger:
  event:
  - push